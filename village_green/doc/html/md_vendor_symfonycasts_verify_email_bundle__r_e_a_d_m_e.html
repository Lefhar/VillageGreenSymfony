<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>village green: VerifyEmailBundle: Love Confirming Emails</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">village green
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">VerifyEmailBundle: Love Confirming Emails </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Don't know if your user's have a valid email address? The VerifyEmailBundle can help!</p>
<p >VerifyEmailBundle generates - and validates - a secure, signed URL that can be emailed to users to confirm their email address. It does this without needing any storage, so you can use your existing entities with minor modifications. This bundle provides:</p>
<p >1) A generator to create a signed URL that should be emailed to the user.</p>
<p >2) A signed URL validator.</p>
<p >3) Peace of mind knowing that this is done without leaking the user's email address into your server logs (avoiding PII problems).</p>
<h1><a class="anchor" id="autotoc_md2007"></a>
Installation</h1>
<p >Using Composer of course!</p>
<div class="fragment"><div class="line">composer require symfonycasts/verify-email-bundle</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2008"></a>
Usage</h1>
<p >We strongly suggest using Symfony MakerBundle's <code>make:registration-form</code> to get a feel for how the bundle should be used. It's super simple! Answer a couple questions, and you'll have a fully functional secure registration system with email verification.</p>
<h1><a class="anchor" id="autotoc_md2009"></a>
Setting things up manually</h1>
<p >If you want to set things up manually, you can! But do so carefully: email verification is a sensitive, security process. We'll guide you through the important stuff. Using <code>make:registration-form</code> is still the easiest and simplest way.</p>
<p >The example below demonstrates the basic steps to generate a signed URL that is to be emailed to a user after they have registered. The URL is then validated once the user "clicks" the link in their email.</p>
<p >The example below utilizes Symfony's <code>AbstractController</code> available in the <a href="https://github.com/symfony/framework-bundle">Framework Bundle</a></p>
<div class="fragment"><div class="line"><span class="comment">// RegistrationController.php</span></div>
<div class="line"> </div>
<div class="line">use <a class="code hl_class" href="class_symfony_1_1_bridge_1_1_twig_1_1_mime_1_1_templated_email.html">Symfony\Bridge\Twig\Mime\TemplatedEmail</a>;</div>
<div class="line">use <a class="code hl_interface" href="interface_symfony_1_1_component_1_1_mailer_1_1_mailer_interface.html">Symfony\Component\Mailer\MailerInterface</a>;</div>
<div class="line">use <a class="code hl_interface" href="interface_symfony_casts_1_1_bundle_1_1_verify_email_1_1_verify_email_helper_interface.html">SymfonyCasts\Bundle\VerifyEmail\VerifyEmailHelperInterface</a>;</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">class RegistrationController extends AbstractController</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">private</span> $verifyEmailHelper;</div>
<div class="line">    <span class="keyword">private</span> $mailer;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> __construct(VerifyEmailHelperInterface $helper, MailerInterface $mailer)</div>
<div class="line">    {</div>
<div class="line">        $this-&gt;verifyEmailHelper = $helper;</div>
<div class="line">        $this-&gt;mailer = $mailer;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> <span class="keyword">register</span>(): Response</div>
<div class="line">    {</div>
<div class="line">        $user = <span class="keyword">new</span> User();</div>
<div class="line">    </div>
<div class="line">        <span class="comment">// handle the user registration form and persist the new user...</span></div>
<div class="line">    </div>
<div class="line">        $signatureComponents = $this-&gt;verifyEmailHelper-&gt;generateSignature(</div>
<div class="line">                <span class="stringliteral">&#39;registration_confirmation_route&#39;</span>,</div>
<div class="line">                $user-&gt;getId(),</div>
<div class="line">                $user-&gt;getEmail()</div>
<div class="line">            );</div>
<div class="line">        </div>
<div class="line">        $email = <span class="keyword">new</span> TemplatedEmail();</div>
<div class="line">        $email-&gt;from(<span class="stringliteral">&#39;send@example.com&#39;</span>);</div>
<div class="line">        $email-&gt;to($user-&gt;getEmail());</div>
<div class="line">        $email-&gt;htmlTemplate(<span class="stringliteral">&#39;registration/confirmation_email.html.twig&#39;</span>);</div>
<div class="line">        $email-&gt;context([<span class="stringliteral">&#39;signedUrl&#39;</span> =&gt; $signatureComponents-&gt;getSignedUrl()]);</div>
<div class="line">        </div>
<div class="line">        $this-&gt;mailer-&gt;send($email);</div>
<div class="line">    </div>
<div class="line">        <span class="comment">// generate and return a response for the browser</span></div>
<div class="line">    }</div>
<div class="line">...</div>
<div class="ttc" id="aclass_symfony_1_1_bridge_1_1_twig_1_1_mime_1_1_templated_email_html"><div class="ttname"><a href="class_symfony_1_1_bridge_1_1_twig_1_1_mime_1_1_templated_email.html">Symfony\Bridge\Twig\Mime\TemplatedEmail</a></div><div class="ttdef"><b>Definition:</b> TemplatedEmail.php:20</div></div>
<div class="ttc" id="ainterface_symfony_1_1_component_1_1_mailer_1_1_mailer_interface_html"><div class="ttname"><a href="interface_symfony_1_1_component_1_1_mailer_1_1_mailer_interface.html">Symfony\Component\Mailer\MailerInterface</a></div><div class="ttdef"><b>Definition:</b> MailerInterface.php:25</div></div>
<div class="ttc" id="ainterface_symfony_casts_1_1_bundle_1_1_verify_email_1_1_verify_email_helper_interface_html"><div class="ttname"><a href="interface_symfony_casts_1_1_bundle_1_1_verify_email_1_1_verify_email_helper_interface.html">SymfonyCasts\Bundle\VerifyEmail\VerifyEmailHelperInterface</a></div><div class="ttdef"><b>Definition:</b> VerifyEmailHelperInterface.php:22</div></div>
</div><!-- fragment --><p >Once the user has received their email and clicked on the link, the RegistrationController would then validate the signed URL in following method:</p>
<div class="fragment"><div class="line"><span class="comment">// RegistrationController.php</span></div>
<div class="line"> </div>
<div class="line">use <a class="code hl_interface" href="interface_symfony_casts_1_1_bundle_1_1_verify_email_1_1_exception_1_1_verify_email_exception_interface.html">SymfonyCasts\Bundle\VerifyEmail\Exception\VerifyEmailExceptionInterface</a>;</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> verifyUserEmail(Request $request): Response</div>
<div class="line">    {</div>
<div class="line">        $this-&gt;denyAccessUnlessGranted(<span class="stringliteral">&#39;IS_AUTHENTICATED_FULLY&#39;</span>);</div>
<div class="line">        $user = $this-&gt;getUser();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Do not get the User&#39;s Id or Email Address from the Request object</span></div>
<div class="line">        <span class="keywordflow">try</span> {</div>
<div class="line">            $this-&gt;verifyEmailHelper-&gt;validateEmailConfirmation($request-&gt;getUri(), $user-&gt;getId(), $user-&gt;getEmail());</div>
<div class="line">        } <span class="keywordflow">catch</span> (VerifyEmailExceptionInterface $e) {</div>
<div class="line">            $this-&gt;addFlash(<span class="stringliteral">&#39;verify_email_error&#39;</span>, $e-&gt;getReason());</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">return</span> $this-&gt;redirectToRoute(<span class="stringliteral">&#39;app_register&#39;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Mark your user as verified. e.g. switch a User::verified property to true</span></div>
<div class="line"> </div>
<div class="line">        $this-&gt;addFlash(<span class="stringliteral">&#39;success&#39;</span>, <span class="stringliteral">&#39;Your e-mail address has been verified.&#39;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> $this-&gt;redirectToRoute(<span class="stringliteral">&#39;app_home&#39;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="ainterface_symfony_casts_1_1_bundle_1_1_verify_email_1_1_exception_1_1_verify_email_exception_interface_html"><div class="ttname"><a href="interface_symfony_casts_1_1_bundle_1_1_verify_email_1_1_exception_1_1_verify_email_exception_interface.html">SymfonyCasts\Bundle\VerifyEmail\Exception\VerifyEmailExceptionInterface</a></div><div class="ttdef"><b>Definition:</b> VerifyEmailExceptionInterface.php:19</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2010"></a>
Anonymous Validation</h1>
<p >It is also possible to allow users to verify their email address without having to be authenticated. A use case for this would be if a user registers on their laptop, but clicks the verification link on their phone. Normally, the user would be required to log in before their email was verified.</p>
<p >We can overcome this by passing a user identifier as a query parameter in the signed url. The diff below demonstrate how this is done based off of the previous examples.</p>
<div class="fragment"><div class="line">// RegistrationController.php</div>
<div class="line"> </div>
<div class="line">    public function register(): Response</div>
<div class="line">    {</div>
<div class="line">        $user = new User();</div>
<div class="line">    </div>
<div class="line">        // handle the user registration form and persist the new user...</div>
<div class="line">    </div>
<div class="line">        $signatureComponents = $this-&gt;verifyEmailHelper-&gt;generateSignature(</div>
<div class="line">                &#39;registration_confirmation_route&#39;,</div>
<div class="line">                $user-&gt;getId(),</div>
<div class="line">-               $user-&gt;getEmail()</div>
<div class="line">+               $user-&gt;getEmail(),</div>
<div class="line">+               [&#39;id&#39; =&gt; $user-&gt;getId()] // add the user&#39;s id as an extra query param</div>
<div class="line">         );</div>
</div><!-- fragment --><p >Once the user has received their email and clicked on the link, the RegistrationController would then validate the signed URL in the following method:</p>
<div class="fragment"><div class="line">// RegistrationController.php</div>
<div class="line"> </div>
<div class="line">+ use App\Repository\UserRepository;</div>
<div class="line"> </div>
<div class="line">-   public function verifyUserEmail(Request $request): Response</div>
<div class="line">+   public function verifyUserEmail(Request $request, UserRepository $userRepository): Response</div>
<div class="line">    {</div>
<div class="line">-       $this-&gt;denyAccessUnlessGranted(&#39;IS_AUTHENTICATED_FULLY&#39;);</div>
<div class="line">-       $user = $this-&gt;getUser();</div>
<div class="line"> </div>
<div class="line">+       $id = $request-&gt;get(&#39;id&#39;); // retrieve the user id from the url</div>
<div class="line">+</div>
<div class="line">+       // Verify the user id exists and is not null</div>
<div class="line">+       if (null === $id) {</div>
<div class="line">+           return $this-&gt;redirectToRoute(&#39;app_home&#39;);</div>
<div class="line">+       }</div>
<div class="line">+</div>
<div class="line">+       $user = $userRepository-&gt;find($id);</div>
<div class="line">+</div>
<div class="line">+       // Ensure the user exists in persistence</div>
<div class="line">+       if (null === $user) {</div>
<div class="line">+           return $this-&gt;redirectToRoute(&#39;app_home&#39;);</div>
<div class="line">+       }</div>
<div class="line"> </div>
<div class="line">        try {</div>
<div class="line">            $this-&gt;verifyEmailHelper-&gt;validateEmailConfirmation($request-&gt;getUri(), $user-&gt;getId(), $user-&gt;getEmail());</div>
<div class="line">        } catch (VerifyEmailExceptionInterface $e) {</div>
<div class="line">        // ...</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2011"></a>
Configuration</h1>
<p >You can change the default configuration parameters for the bundle by creating a <code>config/packages/verify_email.yaml</code> config file.</p>
<div class="fragment"><div class="line">symfonycasts_verify_email:</div>
<div class="line">    lifetime: 3600</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md2012"></a>
&lt;tt&gt;lifetime&lt;/tt&gt;</h3>
<p ><em>Optional</em> - Defaults to <code>3600</code> seconds</p>
<p >This is the length of time a signed URL is valid for in seconds after it has been created.</p>
<h1><a class="anchor" id="autotoc_md2013"></a>
Support</h1>
<p >Feel free to open an issue for questions, problems, or suggestions with our bundle. Issues pertaining to Symfony's Maker Bundle, specifically <code>make:registration-form</code>, should be addressed in the <a href="https://github.com/symfony/maker-bundle">Symfony Maker repository</a>.</p>
<h1><a class="anchor" id="autotoc_md2014"></a>
Security Issues</h1>
<p >For <b>security related vulnerabilities</b>, we ask that you send an email to <code>ryan [at] symfonycasts.com</code> instead of creating an issue.</p>
<p >This will give us the opportunity to address the issue without exposing the vulnerability before a fix can be published. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
